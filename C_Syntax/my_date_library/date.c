#include "date.h"
#include <stdio.h>
#include <stdlib.h>
#include <time.h>


#define     PRIVATE             static //for internal linkage
#define     PUBLIC
#define     YEARBASE            1900
#define     RANDOM_YEAR_MIN     2000
#define     RANDOM_YEAR_MAX     2050


#define     isleap(y)           ((y) % 4 == 0 && ((y) % 100 != 0 || (y) % 400 == 0))
#define     month_days(y, m)     (daytabs[isleap(y)][m])

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PRIVATE const int daytabs[][13] = { //leap year or not lookup table
        {0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31,},
        {0, 31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31,}
};

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PRIVATE int is_valid_date(int d, int m, int y);

PRIVATE Date* set(Date* p, int d, int m, int y);

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------


/** public functions */

PUBLIC Date* set_date(Date* p, int d, int m, int y)
{
    return set(p, d, m, y);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC Date* set_date_today(Date* p)
{
    time_t timer;
    time(&timer);
    struct tm* tptr = localtime(&timer);

    return set(p, tptr->tm_mday, tptr->tm_mon + 1, tptr->tm_year + 1900);
}


//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

//dd-mm-yyyy
PUBLIC Date* set_date_str(Date* p, const char* pstr)
{
    int d = atoi(pstr);
    int m = atoi(pstr + 3);
    int y = atoi(pstr + 6);

    return set(p , d, m, y);

}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC Date* set_date_random(Date *p)
{
    int y = rand() % (RANDOM_YEAR_MAX - RANDOM_YEAR_MIN + 1) + RANDOM_YEAR_MIN;
    int m = rand() % 12 + 1;
    int d = rand() % month_days(y, m)+ 1;

    return set(p, d, m, y);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC Date* set_month_day(Date* p, int mday)
{
    return set(p, mday, p->mmon, p->myear);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC Date* set_month(Date* p, int mon)
{
    return set(p, p->mday, mon, p->myear);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC Date* set_year(Date* p, int year)
{
    return set(p, p-> mday, p->mmon, year);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PUBLIC void print_date(const Date* p);

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------


/** private functions */

PRIVATE int is_valid_date(int d, int m, int y)
{
    return y >= YEARBASE && m > 0 && m <= 12 && d > 0 && d <= month_days(y, m);
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------

PRIVATE Date* set(Date* p, int d, int m, int y)
{
    if (!is_valid_date(d, m, y)) {
        fprintf(stderr, "Valid date created!\n");
        exit(EXIT_FAILURE);
    }
    p->mday = d;
    p->mmon = m;
    p->myear = y;

    return p;
}

//----------------------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------------------------
